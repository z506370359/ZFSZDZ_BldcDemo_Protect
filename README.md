# ⚡ STM32 BLDC 闭环控制与多重保护工程 (Protect 完整版)

> **所属课程**：张飞实战电子“扬帆起航”课程电机控制部分
> **当前版本**：V1.0.0
> **开发作者**：ZhaoYun (ZFSZDZ)
> **项目定位**：在基础开环控制之上，实现了电机实际转速计算、一阶低通滤波、速度闭环控制，并构建了极其完备的 8 大核心硬件/软件故障保护机制。

---

## 🛠️ 一、 硬件平台与核心参数

系统基于 STM32G030 平台开发，深度结合霍尔传感器与三相逆变桥，关键系统级参数配置如下：

* **核心 MCU**：`STM32G030` (系统主频配置为 64MHz)
* **PWM 驱动频率**：`16kHz`
* **电机极对数**：`2`
* **运行转速范围**：100 RPM ~ 3000 RPM

---

## ⚙️ 二、 核心控制与算法特性

相较于开环版本，本项目在控制算法上进行了全面升级：

1. **精准闭环调速 (Closed-Loop PI Control)**
默认工作在 `RUNMODE_CLOSELOOP`（速度闭环模式），系统内置了 PI（比例-积分）控制器，动态调节占空比以精准锁定目标转速。
2. **转速采集与数字滤波 (Speed Calc & Low-Pass Filter)**
利用霍尔信号实时计算电机真实转速，并加入了一阶数字低通滤波器。显示速度滤波的截止频率被精心设定为 `50Hz`，有效消除了速度反馈中的高频噪声抖动。
3. **多模式兼容 (Multi-Mode Support)**
同时支持电位器模拟调速 (`SPEEDMODE_POT`) 与 USART 串口数字调速 (`SPEEDMODE_USART`)，兼顾本地调试与上位机控制。

---

## 🛡️ 三、 八重故障保护机制 (Protect System)

本工程最核心的亮点在于其坚不可摧的保护逻辑。系统严格按照优先级（数字越小，优先级越高，响应越快）监控并处理以下 8 种异常工况：

| 优先级 | 保护类型 | 触发与恢复条件 |
| --- | --- | --- |
| **1** | 🔴 **硬件过流保护** | 底层硬件瞬态触发，最高优先级 |
| **2** | 🟠 **堵转电流保护** | 监测到长时间大电流且转速异常时触发 |
| **3** | 🟡 **堵转相位保护** | 霍尔信号长时间未按预期跳变时触发 |
| **4** | 🔵 **软件过流保护** | 电流 ADC 采样值换算超过 **4A** 时触发 |
| **5** | 🟣 **Vbus 过压保护** | 母线电压 > **30V** 触发，降至 **29V** 恢复运行 |
| **6** | 🟤 **Vbus 欠压保护** | 母线电压 < **21V** 触发，升至 **22V** 恢复运行 |
| **7** | ⚫ **过温保护** | 散热器/系统温度 ≥ **60℃** 触发，降至 **58℃** 恢复运行 |
| **8** | ⚪ **启动失败保护** | 启动初始化序列未能成功带动转子时触发 |

---

## 🔄 四、 状态机架构 (FSM)

电机的底层运行依旧由健壮的状态机逻辑接管，确保换相与保护逻辑不发生冲突：

* 🛑 `0 - STOP_STATE`：停机安全状态
* 🔋 `1 - CHARGEREADY_STATE`：自举电容充电准备
* ⏳ `2 - CHARGEWAIT_STATE`：等待充电完成
* 🚀 `3 - STARTINIT_STATE`：启动初始化
* 🟢 `4 - MOTORRUN_STATE`：电机闭环稳定运行
* 🛠️ `5 - TEST_STATE`：系统测试模式

---

## 📝 五、 关键用户可配置参数

您可以直接在 `Include/UserParams.h` 中快速调整系统的宏定义，以适配不同的电机硬件：

```c
// [核心配置]
#define DEFAULT_SPEEDMODE       (SPEEDMODE_POT)     // 默认：电位器调速
#define DEFAULT_RUNMODE         (RUNMODE_CLOSELOOP) // 默认：闭环运行模式
#define DEFAULT_DIR             (DIR_CW)            // 默认：顺时针旋转

// [启动与运行限制]
#define START_MIN_DUTY          (100)               // 启动最小占空比 10%
#define RUN_MAX_SPEED           (3000)              // 运行最大转速 3000 RPM

// [信号处理]
#define MOTOR_POLEPAIRS         (2)                 // 极对数
#define LOWPASS_FILTER_FACTOR   (20578)             // 50Hz 低通滤波系数

```
